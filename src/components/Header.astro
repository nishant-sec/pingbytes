---
import Link from '@/components/Link.astro'
import MobileMenu from '@/components/ui/mobile-menu'
import SearchButton from './react/SearchButton'
import ThemeSelector from '@/components/react/ThemeSelector'
import { NAV_LINKS } from '@/consts'
import { Icon } from 'astro-icon/components'
import { cn } from '@/lib/utils'

const isExternalLink = (href: string) => {
  return href.startsWith('http')
}

const normalizePath = (path: string) => {
  if (!path) return '/'
  const trimmed = path.replace(/\/+$/, '')
  return trimmed === '' ? '/' : trimmed
}

const currentPath = normalizePath(Astro.url.pathname)
const isActiveLink = (href: string) => {
  const target = normalizePath(href)
  if (target === '/') return currentPath === '/'
  return currentPath === target || currentPath.startsWith(`${target}/`)
}
---

<header class="bg-background/80 sticky top-0 z-50 w-full border-b border-border/40 backdrop-blur-xl transition-all duration-300" transition:persist>
  <div class="mx-auto flex h-16 max-w-5xl items-center justify-between px-4 sm:px-6">
    <Link href="/" class="flex items-center gap-2 group transition-transform active:scale-95">
      <span class="brand-logo">
        Merox
      </span>
    </Link>
    
    <div class="flex items-center gap-2 md:gap-8">
      <nav class="hidden items-center gap-1 text-sm font-medium md:flex" data-nav-links>
        {NAV_LINKS.map((item) => {
          const isExternal = isExternalLink(item.href)
          const isInsideLink = item.label.toLowerCase() === 'inside'
          const isActive = isActiveLink(item.href)
          return (
            <Link 
              href={item.href} 
              data-nav-link
              data-active={isActive ? 'true' : 'false'}
              data-inside={isInsideLink ? 'true' : 'false'}
              class={cn(
                "group relative px-3 py-2 rounded-full transition-all duration-200 after:pointer-events-none after:absolute after:left-3 after:right-3 after:bottom-1 after:h-[2px] after:origin-center after:scale-x-0 after:bg-current after:opacity-80 after:transition-transform after:duration-200 after:ease-out after:content-[''] hover:after:scale-x-100",
                isInsideLink ? "text-primary/90 hover:text-primary" : "text-foreground/70 hover:text-foreground",
                isActive && "is-active after:scale-x-100"
              )}
            >
              <span class="flex items-center gap-1.5">
                {item.label}
                {isExternal && (
                  <Icon 
                    name="lucide:external-link" 
                    class="size-3 opacity-60 group-hover:opacity-100 transition-opacity" 
                    aria-hidden="true"
                  />
                )}
              </span>
            </Link>
          )
        })}
      </nav>

      <div class="flex items-center gap-2">
        <div class="hidden h-5 w-px bg-border/40 md:block" aria-hidden="true"></div>
        <SearchButton client:idle />
        <div class="hidden md:flex items-center">
          <ThemeSelector client:idle />
        </div>
        <MobileMenu client:idle transition:persist />
      </div>
    </div>
  </div>
</header>

<style>
  nav[data-nav-links] a[data-nav-link].is-active {
    color: var(--foreground);
  }

  nav[data-nav-links] a[data-nav-link][data-inside="true"].is-active {
    color: var(--primary);
  }

  nav[data-nav-links] a[data-nav-link].is-active::after {
    --tw-scale-x: 1;
    transform: var(--tw-transform);
  }
</style>

<script is:inline>
  (() => {
    const normalizePath = (path) => {
      if (!path) return '/'
      const trimmed = path.split('#')[0].replace(/\/+$/, '')
      return trimmed === '' ? '/' : trimmed
    }

    const setActiveLink = () => {
      const current = normalizePath(window.location.pathname)
      document
        .querySelectorAll('nav[data-nav-links] a[data-nav-link]')
        .forEach((link) => {
          const href = link.getAttribute('href') || '/'
          const target = normalizePath(href)
          const isActive =
            target === '/'
              ? current === '/'
              : current === target || current.startsWith(`${target}/`)
          link.setAttribute('data-active', isActive ? 'true' : 'false')
          link.classList.toggle('is-active', isActive)
          link.classList.toggle('after:scale-x-100', isActive)
          link.classList.toggle('after:scale-x-0', !isActive)
        })
    }

    setActiveLink()
    window.addEventListener('popstate', setActiveLink)
    document.addEventListener('astro:after-swap', setActiveLink)
    document.addEventListener(
      'click',
      (event) => {
        const target = event.target?.closest?.('a[data-nav-link]')
        if (!target) return
        // Run after navigation completes
        setTimeout(setActiveLink, 0)
      },
      true,
    )
  })()
</script>
