---
import {
  getCombinedReadingTime,
  getSubpostCount,
  isSubpost,
} from '@/lib/data-utils'
import { cn, formatDate, getTagVariant } from '@/lib/utils'
import { Icon } from 'astro-icon/components'
import type { CollectionEntry } from 'astro:content'
import Link from './Link.astro'

interface Props {
  entry: CollectionEntry<'blog'>
}

const { entry } = Astro.props
const formattedDate = formatDate(entry.data.date)
const readTime = await getCombinedReadingTime(entry.id)
const subpostCount = !isSubpost(entry.id) ? await getSubpostCount(entry.id) : 0
---

<Link
  href={`/${entry.collection}/${entry.id}`}
  class="group block -mx-4 rounded-xl border border-transparent px-4 py-6 shadow-none transition-all duration-300 hover:-translate-y-0.5 hover:border-border/50 hover:bg-muted/40 hover:shadow-sm"
>
  <div class="flex flex-col gap-3">
    <div class="space-y-2">
      <div class="flex items-start justify-between gap-4">
        <h3 class="text-lg font-bold leading-tight text-foreground/90 transition-colors duration-300 group-hover:text-primary">
          {entry.data.title}
        </h3>
        <Icon
          name="lucide:arrow-up-right"
          class="mt-1 size-4 shrink-0 text-muted-foreground/30 transition-all duration-300 group-hover:-translate-y-0.5 group-hover:translate-x-0.5 group-hover:text-primary"
        />
      </div>

      <p class="text-sm leading-relaxed text-muted-foreground/80 line-clamp-2">
        {entry.data.description}
      </p>
    </div>

    <div class="flex flex-wrap items-center gap-x-3 gap-y-2 text-[11px] font-medium text-muted-foreground/60">
      <time
        datetime={entry.data.date.toISOString()}
        class="flex items-center gap-1.5 uppercase tracking-wider"
      >
        <Icon name="lucide:calendar" class="size-3" />
        {formattedDate}
      </time>

      <span class="text-muted-foreground/20" aria-hidden="true">/</span>

      <span class="flex items-center gap-1.5">
        <Icon name="lucide:clock" class="size-3" />
        {readTime}
      </span>

      {
        subpostCount > 0 && (
          <>
            <span class="text-muted-foreground/20" aria-hidden="true">/</span>
            <span class="flex items-center gap-1.5">
              <Icon name="lucide:file-text" class="size-3" />
              {subpostCount} {subpostCount === 1 ? 'part' : 'parts'}
            </span>
          </>
        )
      }

      {
        entry.data.tags && entry.data.tags.length > 0 && (
          <>
            <span class="text-muted-foreground/20" aria-hidden="true">/</span>
            <div class="flex flex-wrap items-center gap-1.5">
              {entry.data.tags.slice(0, 2).map((tag) => {
                const { className } = getTagVariant(tag)
                return (
                  <span
                    class={cn(
                      'rounded-md bg-muted/50 px-1.5 py-0.5 text-[10px] uppercase tracking-wide transition-colors',
                      className,
                    )}
                  >
                    {tag}
                  </span>
                )
              })}
            </div>
          </>
        )
      }
    </div>
  </div>
</Link>
