---
import { buttonVariants } from '@/components/ui/button'
import { Icon } from 'astro-icon/components'
import { cn } from '@/lib/utils'

interface Props {
  title: string
  url: string
  description?: string
  className?: string
}

const { title, url, description, className } = Astro.props

// Encode URL and text for sharing
const encodedUrl = encodeURIComponent(url)
const encodedTitle = encodeURIComponent(title)

// Social sharing URLs
const shareLinks = {
  twitter: `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}${description ? `&via=meroxdotdev` : ''}`,
  linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`,
  reddit: `https://reddit.com/submit?url=${encodedUrl}&title=${encodedTitle}`,
  facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
}

// Scope selector so multiple share blocks don't clash
const shareScope = `share-${Math.random().toString(36).substring(2, 9)}`
---

<section
  class={cn('flex flex-col gap-3', className)}
  data-share-scope={shareScope}
  aria-label="Share this post"
>
  <h3 class="text-sm font-semibold text-muted-foreground">Share this post</h3>
  <div class="flex flex-wrap items-center gap-2">
    <!-- Twitter/X -->
    <a
      href={shareLinks.twitter}
      target="_blank"
      rel="noopener noreferrer"
      class={cn(
        buttonVariants({ variant: 'outline', size: 'sm' }),
        'group',
      )}
      aria-label="Share on Twitter/X"
      title="Share on Twitter/X"
    >
      <Icon
        name="simple-icons:x"
        class="size-4 transition-transform group-hover:scale-110"
      />
      <span class="sr-only">Share on Twitter/X</span>
    </a>

    <!-- LinkedIn -->
    <a
      href={shareLinks.linkedin}
      target="_blank"
      rel="noopener noreferrer"
      class={cn(
        buttonVariants({ variant: 'outline', size: 'sm' }),
        'group',
      )}
      aria-label="Share on LinkedIn"
      title="Share on LinkedIn"
    >
      <Icon
        name="simple-icons:linkedin"
        class="size-4 transition-transform group-hover:scale-110"
      />
      <span class="sr-only">Share on LinkedIn</span>
    </a>

    <!-- Reddit -->
    <a
      href={shareLinks.reddit}
      target="_blank"
      rel="noopener noreferrer"
      class={cn(
        buttonVariants({ variant: 'outline', size: 'sm' }),
        'group',
      )}
      aria-label="Share on Reddit"
      title="Share on Reddit"
    >
      <Icon
        name="simple-icons:reddit"
        class="size-4 transition-transform group-hover:scale-110"
      />
      <span class="sr-only">Share on Reddit</span>
    </a>

    <!-- Facebook -->
    <a
      href={shareLinks.facebook}
      target="_blank"
      rel="noopener noreferrer"
      class={cn(
        buttonVariants({ variant: 'outline', size: 'sm' }),
        'group',
      )}
      aria-label="Share on Facebook"
      title="Share on Facebook"
    >
      <Icon
        name="simple-icons:facebook"
        class="size-4 transition-transform group-hover:scale-110"
      />
      <span class="sr-only">Share on Facebook</span>
    </a>

    <!-- Copy Link -->
    <button
      type="button"
      data-share-url={url}
      data-share-scope={shareScope}
      class={cn(
        buttonVariants({ variant: 'outline', size: 'sm' }),
        'group',
      )}
      aria-label="Copy link to clipboard"
      title="Copy link to clipboard"
    >
      <Icon
        name="lucide:link"
        class="size-4 transition-transform group-hover:scale-110"
      />
      <span class="sr-only">Copy link</span>
    </button>
  </div>
</section>

<script type="module" is:inline>
  import { registerPageController } from '@/lib/client/lifecycle'
  import { registerCopyButtons } from '@/lib/client/share'

  const getShareScope = () => {
    const el = document.querySelector('[data-share-scope]')
    return el?.getAttribute('data-share-scope') || ''
  }

  let cleanup = () => {}

  registerPageController({
    init: () => {
      cleanup()
      const scope = getShareScope()
      const selector = scope
        ? `button[data-share-url][data-share-scope="${scope}"]`
        : 'button[data-share-url]'
      cleanup = registerCopyButtons({ selector })
    },
    cleanup: () => cleanup(),
  })
</script>
