---
---

<script is:inline data-astro-rerun>
  (() => {
    // Theme initialization (light/dark mode only)
    const getTheme = () => {
      try {
        const stored = localStorage?.getItem('theme') ?? ''
        if (['dark', 'light'].includes(stored)) return stored
        return window.matchMedia('(prefers-color-scheme: dark)').matches
          ? 'dark'
          : 'light'
      } catch {
        return 'light'
      }
    }

    // Palette initialization
    const getPalette = () => {
      try {
        const stored = localStorage?.getItem('color-palette')
        const validPalettes = ['blue', 'green', 'purple', 'orange', 'rose', 'cyan', 'teal']
        return stored && validPalettes.includes(stored) ? stored : 'blue'
      } catch {
        return 'blue'
      }
    }

    const theme = getTheme()
    const palette = getPalette()

    document.documentElement.setAttribute('data-theme', theme)
    document.documentElement.setAttribute('data-palette', palette)
    
    try {
      localStorage.setItem('theme', theme)
      if (!localStorage.getItem('color-palette')) {
        localStorage.setItem('color-palette', palette)
      }
    } catch {
      // localStorage unavailable - continue without persistence
    }
  })()
</script>

<script>
  // Restore theme and palette after navigation
  document.addEventListener('astro:after-swap', () => {
    const getTheme = () => {
      try {
        const stored = localStorage.getItem('theme')
        return stored && ['dark', 'light'].includes(stored) ? stored : 'light'
      } catch {
        return 'light'
      }
    }

    const getPalette = () => {
      try {
        const stored = localStorage.getItem('color-palette')
        const validPalettes = ['blue', 'green', 'purple', 'orange', 'rose', 'cyan', 'teal']
        return stored && validPalettes.includes(stored) ? stored : 'blue'
      } catch {
        return 'blue'
      }
    }

    const storedTheme = getTheme()
    const storedPalette = getPalette()
    const element = document.documentElement

    element.classList.add('[&_*]:transition-none')
    window.getComputedStyle(element).getPropertyValue('opacity')
    element.setAttribute('data-theme', storedTheme)
    element.setAttribute('data-palette', storedPalette)

    requestAnimationFrame(() => {
      element.classList.remove('[&_*]:transition-none')
    })
  })
</script>

