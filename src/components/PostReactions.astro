---
import { cn } from '@/lib/utils'
import { Icon } from 'astro-icon/components'

const { postId, className } = Astro.props
---

<section
  class={cn('flex flex-col gap-3', className)}
  aria-label="Post reactions"
>
  <div class="flex flex-wrap items-center gap-2">
    <button
      type="button"
      data-reaction="clap"
      data-post-id={postId}
      class="group relative flex items-center gap-1.5 rounded-full bg-muted/60 px-3 py-2 text-sm transition-all hover:bg-muted focus:outline-none focus:ring-0 focus:ring-offset-0 border border-transparent disabled:opacity-60 disabled:cursor-not-allowed"
      aria-label="React with clap"
      title="Clap"
    >
      <span class="text-lg leading-none" aria-hidden="true">üëè</span>
      <span class="text-xs font-semibold text-foreground" data-count="clap-count">0</span>
    </button>

    <div class="relative" data-share-container>
      <button
        type="button"
        data-share="post"
        class="group flex items-center justify-center gap-2 rounded-full bg-muted/60 px-3 py-2 text-sm transition-all hover:bg-muted focus:outline-none focus:ring-0 focus:ring-offset-0 border border-transparent"
        aria-label="Share this post"
        title="Share"
        aria-expanded="false"
        aria-haspopup="true"
      >
        <Icon name="lucide:share-2" class="size-4 text-foreground transition-transform group-hover:scale-110" aria-hidden="true" />
      </button>
      <div
        data-share-menu
        class="absolute left-0 top-full mt-2 hidden rounded-lg border border-border bg-background p-2 shadow-lg min-w-[180px] z-30"
      >
        <div class="flex flex-wrap gap-2">
          <a
            data-share-target="twitter"
            href="#"
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center gap-2 rounded-md px-3 py-2 text-xs font-semibold text-foreground transition-colors hover:bg-muted"
          >
            <Icon name="simple-icons:x" class="size-4" aria-hidden="true" />
            <span class="sr-only">Share on X</span>
          </a>
          <a
            data-share-target="linkedin"
            href="#"
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center gap-2 rounded-md px-3 py-2 text-xs font-semibold text-foreground transition-colors hover:bg-muted"
          >
            <Icon name="simple-icons:linkedin" class="size-4" aria-hidden="true" />
            <span class="sr-only">Share on LinkedIn</span>
          </a>
          <a
            data-share-target="reddit"
            href="#"
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center gap-2 rounded-md px-3 py-2 text-xs font-semibold text-foreground transition-colors hover:bg-muted"
          >
            <Icon name="simple-icons:reddit" class="size-4" aria-hidden="true" />
            <span class="sr-only">Share on Reddit</span>
          </a>
          <a
            data-share-target="facebook"
            href="#"
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center gap-2 rounded-md px-3 py-2 text-xs font-semibold text-foreground transition-colors hover:bg-muted"
          >
            <Icon name="simple-icons:facebook" class="size-4" aria-hidden="true" />
            <span class="sr-only">Share on Facebook</span>
          </a>
          <button
            type="button"
            data-share-copy
            class="relative flex items-center gap-2 rounded-md px-3 py-2 text-xs font-semibold text-foreground transition-colors hover:bg-muted"
          >
            <Icon name="lucide:link" class="size-4" aria-hidden="true" />
            <span class="sr-only" data-share-copy-label>Copy</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // @ts-nocheck
  // Plain JS reactions
  ;(() => {
    const USER_REACTIONS_KEY = 'user-post-reactions'
    const API_BASE = '/api/reactions'

    let reactionButtons = []
    let shareContainers = []
    let openShareContainer = null
    let timeoutId = null
    let scaleTimeoutIds = new Map()
    const processingButtons = new Set()
    let serverReactions = {}
    let currentPostId = null

    const getUserReactions = () => {
      try {
        const stored = localStorage.getItem(USER_REACTIONS_KEY)
        return stored ? JSON.parse(stored) : {}
      } catch {
        return {}
      }
    }

    const hasUserReacted = (postId, reactionKey) => {
      const userReactions = getUserReactions()
      const postReactions = userReactions[postId] || []
      if (reactionKey) return postReactions.includes(reactionKey)
      return postReactions.length > 0
    }

    const markUserReacted = (postId, reactionKey) => {
      const userReactions = getUserReactions()
      if (!userReactions[postId]) {
        userReactions[postId] = []
      }
      if (!userReactions[postId].includes(reactionKey)) {
        userReactions[postId].push(reactionKey)
        try {
          localStorage.setItem(USER_REACTIONS_KEY, JSON.stringify(userReactions))
        } catch (err) {
          console.warn('Failed to save user reactions', err)
        }
      }
    }

    const fetchReactionCounts = async (postId) => {
      try {
        const response = await fetch(`${API_BASE}/${postId}`)
        if (!response.ok) {
          console.warn('Failed to fetch reaction counts:', response.statusText)
          return
        }
        const data = await response.json()
        serverReactions = data.reactions ?? {}

        reactionButtons.forEach((button) => {
          const reactionKey = button.dataset.reaction
          if (!reactionKey) return

          const count = serverReactions[reactionKey] ?? 0
          const countElement = button.querySelector('[data-count]')
          if (countElement) countElement.textContent = count.toString()
        })
      } catch (error) {
        console.error('Error fetching reaction counts:', error)
      }
    }

    const getReactionCount = (reactionKey) => serverReactions[reactionKey] || 0

    const incrementReaction = async (postId, reactionKey) => {
      if (hasUserReacted(postId)) {
        return { count: null, rateLimited: false }
      }

      try {
        const response = await fetch(`${API_BASE}/${postId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reactionKey }),
        })

        let data = {}
        try {
          data = await response.json()
        } catch (err) {
          console.warn('Failed to parse reaction response', err)
        }

        if (response.status === 429) {
          // Rate limited by server (IP-based)
          if (data.reactions) {
            serverReactions = data.reactions
          }
          return {
            count: data.count ?? getReactionCount(reactionKey),
            rateLimited: true,
            message:
              data.error || 'Rate limit exceeded. Please try again later.',
          }
        }

        if (!response.ok) {
          console.error('Failed to update reaction:', response.statusText)
          return { count: null, rateLimited: false }
        }

        serverReactions = data.reactions ?? {}
        markUserReacted(postId, reactionKey)

        return {
          count: data.count ?? serverReactions[reactionKey] ?? 0,
          rateLimited: false,
        }
      } catch (error) {
        console.error('Error updating reaction:', error)
        return { count: null, rateLimited: false }
      }
    }

    const updateReactionDisplay = (button, count, isReacted = false) => {
      const countElement = button.querySelector('[data-count]')
      if (countElement) countElement.textContent = count.toString()

      if (isReacted) {
        button.disabled = true
        button.classList.add('opacity-60', 'cursor-not-allowed')
        button.classList.remove('hover:bg-muted')
        button.setAttribute(
          'aria-label',
          (button.getAttribute('aria-label') || '') + ' (already reacted)',
        )
      } else {
        button.disabled = false
        button.classList.remove('opacity-60', 'cursor-not-allowed')
        button.classList.add('hover:bg-muted')
      }

      if (!isReacted) {
        const existingTimeout = scaleTimeoutIds.get(button)
        if (existingTimeout) clearTimeout(existingTimeout)
        button.classList.add('scale-105')
        const scaleTimeout = setTimeout(() => {
          button.classList.remove('scale-105')
          scaleTimeoutIds.delete(button)
        }, 200)
        scaleTimeoutIds.set(button, scaleTimeout)
      }
    }

    const initializeReactionCounts = async () => {
      if (!currentPostId || reactionButtons.length === 0) return

      await fetchReactionCounts(currentPostId)

      reactionButtons.forEach((button) => {
        const postId = button.dataset.postId || ''
        const reactionKey = button.dataset.reaction
        if (!postId || !reactionKey) return

        const count = getReactionCount(reactionKey)
        const hasReacted = hasUserReacted(postId)
        updateReactionDisplay(button, count, hasReacted)
      })
    }

    const handleReactionClick = async (e) => {
      const button = e.currentTarget
      if (!button) return

      const postId = button.dataset.postId
      const reactionKey = button.dataset.reaction
      if (!postId || !reactionKey) return

      if (processingButtons.has(button)) {
        e.preventDefault()
        return
      }

      if (hasUserReacted(postId)) {
        e.preventDefault()
        updateReactionDisplay(button, getReactionCount(reactionKey), true)
        return
      }

      e.preventDefault()
      processingButtons.add(button)
      button.disabled = true

      const result = await incrementReaction(postId, reactionKey)

      if (result?.rateLimited) {
        // Server rate limit hit - disable and show latest count
        const count = result.count ?? getReactionCount(reactionKey)
        updateReactionDisplay(button, count, true)
        const message =
          result.message || 'Rate limit exceeded. Please try again later.'
        button.title = message
        button.setAttribute(
          'aria-label',
          (button.getAttribute('aria-label') || '') + ' (rate limited)',
        )

        // Disable all reactions for this post to avoid more 429s
        reactionButtons.forEach((otherButton) => {
          const otherPostId = otherButton.dataset.postId
          if (otherPostId === postId) {
            otherButton.disabled = true
            otherButton.classList.add('opacity-60', 'cursor-not-allowed')
            otherButton.classList.remove('hover:bg-muted')
          }
        })
      } else if (result && result.count !== null) {
        updateReactionDisplay(button, result.count, true)

        reactionButtons.forEach((otherButton) => {
          const otherPostId = otherButton.dataset.postId
          const otherReactionKey = otherButton.dataset.reaction
          if (!otherPostId || !otherReactionKey || otherPostId !== postId) return

          const otherCount = getReactionCount(otherReactionKey)
          const countElement = otherButton.querySelector('[data-count]')
          if (countElement) countElement.textContent = otherCount.toString()

          if (otherReactionKey !== reactionKey) {
            otherButton.disabled = true
            otherButton.classList.add('opacity-60', 'cursor-not-allowed')
            otherButton.classList.remove('hover:bg-muted')
          }
        })
      } else {
        button.disabled = true
        const count = getReactionCount(reactionKey)
        updateReactionDisplay(button, count, true)
      }

      setTimeout(() => {
        processingButtons.delete(button)
      }, 300)
    }

    const initReactions = () => {
      reactionButtons.forEach((button) => {
        button.removeEventListener('click', handleReactionClick)
      })

      const buttonNodes = document.querySelectorAll(
        'button[data-reaction][data-post-id]',
      )
      reactionButtons = Array.from(buttonNodes)
      if (reactionButtons.length === 0) return

      const firstButton = reactionButtons[0]
      currentPostId = firstButton.dataset.postId || null
      if (!currentPostId) {
        console.error('Post ID not found')
        return
      }

      reactionButtons.forEach((button) => {
        button.addEventListener('click', handleReactionClick)
      })

      initializeReactionCounts()
    }

    const cleanup = () => {
      if (timeoutId) {
        clearTimeout(timeoutId)
        timeoutId = null
      }

      scaleTimeoutIds.forEach((timeout) => {
        clearTimeout(timeout)
      })
      scaleTimeoutIds.clear()

      reactionButtons.forEach((button) => {
        button.removeEventListener('click', handleReactionClick)
      })
      reactionButtons = []

      shareContainers.forEach((container) => {
        const button = container.querySelector('button[data-share="post"]')
        if (button) {
          button.removeEventListener('click', handleShareClick)
        }
      })
      document.removeEventListener('click', handleOutsideShareClick)
      shareContainers = []
      openShareContainer = null
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initReactions)
    } else {
      initReactions()
    }

    document.addEventListener('astro:page-load', () => {
      cleanup()
      timeoutId = setTimeout(() => {
        initReactions()
        initShare()
      }, 0)
    })

    document.addEventListener('astro:before-swap', cleanup)

    async function handleShareClick(e) {
      e.preventDefault()
      const container = (e.currentTarget as HTMLElement)?.closest(
        '[data-share-container]',
      )
      if (!container) return

      const menu = container.querySelector('[data-share-menu]')
      const button = container.querySelector('button[data-share="post"]')
      if (!menu || !button) return

      const isOpen = openShareContainer === container
      if (isOpen) {
        closeShareMenu()
        return
      }

      populateShareLinks(container)
      menu.classList.remove('hidden')
      button.setAttribute('aria-expanded', 'true')
      openShareContainer = container
      setTimeout(() => {
        document.addEventListener('click', handleOutsideShareClick)
      }, 0)
    }

    function handleOutsideShareClick(e) {
      if (!openShareContainer) return
      const target = e.target
      if (
        openShareContainer.contains(target as Node)
      ) {
        return
      }
      closeShareMenu()
    }

    function closeShareMenu() {
      if (openShareContainer) {
        const menu = openShareContainer.querySelector('[data-share-menu]')
        const button = openShareContainer.querySelector('button[data-share="post"]')
        if (menu) menu.classList.add('hidden')
        if (button) button.setAttribute('aria-expanded', 'false')
      }
      openShareContainer = null
      document.removeEventListener('click', handleOutsideShareClick)
    }

    function populateShareLinks(container) {
      const url = window.location.href
      const title = document.title || 'Check this out'
      const encodedUrl = encodeURIComponent(url)
      const encodedTitle = encodeURIComponent(title)

      const linkMap = {
        twitter: `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`,
        linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`,
        reddit: `https://reddit.com/submit?url=${encodedUrl}&title=${encodedTitle}`,
        facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
      }

      Object.entries(linkMap).forEach(([key, href]) => {
        const anchor = container.querySelector(
          `[data-share-target="${key}"]`,
        ) as HTMLAnchorElement | null
        if (anchor) {
          anchor.href = href
        }
      })

      const copyBtn = container.querySelector(
        '[data-share-copy]',
      ) as HTMLButtonElement | null
      if (copyBtn) {
        const originalLabel = copyBtn.getAttribute('aria-label') || 'Copy link'
        const labelEl = copyBtn.querySelector('[data-share-copy-label]') as HTMLElement | null
        copyBtn.onclick = async (evt) => {
          evt.preventDefault()
          try {
            await navigator.clipboard.writeText(url)
            copyBtn.classList.add('text-green-600', 'dark:text-green-400')
            copyBtn.setAttribute('aria-label', 'Link copied')
            copyBtn.title = 'Link copied'
            // Temporary tooltip
            const existingToast = copyBtn.querySelector('[data-share-copy-toast]')
            if (existingToast && existingToast.parentNode) {
              existingToast.parentNode.removeChild(existingToast)
            }
            const toast = document.createElement('span')
            toast.dataset.shareCopyToast = 'true'
            toast.textContent = 'Copied'
            toast.className =
              'absolute left-1/2 -translate-x-1/2 -top-6 text-[10px] font-semibold text-foreground bg-background border border-border rounded-full px-2 py-0.5 shadow-sm'
            copyBtn.appendChild(toast)
            setTimeout(() => {
              copyBtn.classList.remove('text-green-600', 'dark:text-green-400')
              copyBtn.setAttribute('aria-label', originalLabel)
              copyBtn.title = originalLabel
              if (toast.parentNode) {
                toast.parentNode.removeChild(toast)
              }
            }, 1500)
          } catch (err) {
            console.error('Failed to copy link:', err)
          } finally {
            closeShareMenu()
          }
        }
      }
    }

    function initShare() {
      shareContainers = Array.from(
        document.querySelectorAll('[data-share-container]'),
      )
      shareContainers.forEach((container) => {
        const button = container.querySelector('button[data-share="post"]')
        if (button) {
          button.addEventListener('click', handleShareClick)
        }
      })
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initShare)
    } else {
      initShare()
    }

    document.addEventListener('astro:before-swap', () => {
      closeShareMenu()
      shareContainers.forEach((container) => {
        const button = container.querySelector('button[data-share="post"]')
        if (button) {
          button.removeEventListener('click', handleShareClick)
        }
      })
      shareContainers = []
      openShareContainer = null
    })
  })()
</script>
