---
interface Props {
  identifier: string
  title: string
  url?: string
}

const { identifier, title, url } = Astro.props

const defaultGiscus = {
  repo: 'nishant-sec/pingbytes',
  repoId: 'R_kgDOQyiy-A',
  category: 'Announcements',
  categoryId: 'DIC_kwDOQyiy-M4C0sDT',
  theme: 'noborder_gray',
}

const giscusRepo = import.meta.env.PUBLIC_GISCUS_REPO || defaultGiscus.repo
const giscusRepoId = import.meta.env.PUBLIC_GISCUS_REPO_ID || defaultGiscus.repoId
const giscusCategory = import.meta.env.PUBLIC_GISCUS_CATEGORY || defaultGiscus.category
const giscusCategoryId = import.meta.env.PUBLIC_GISCUS_CATEGORY_ID || defaultGiscus.categoryId
const giscusTheme = import.meta.env.PUBLIC_GISCUS_THEME || defaultGiscus.theme

const sanitize = (str: string) => str.replace(/[<>]/g, '').trim().substring(0, 200)

const safeIdentifier = sanitize(identifier)
const safeTitle = sanitize(title)
const pageUrl = url || Astro.url.href
const isConfigured =
  giscusRepo && giscusRepoId && giscusCategory && giscusCategoryId
---

<section
  id="comments-section"
  class="mt-12"
  aria-label="Comments section"
>
  <div id="giscus_thread" class="min-h-[200px]"></div>

  <div
    id="comments-loading"
    class="flex items-center justify-center py-8 text-sm text-muted-foreground"
    aria-live="polite"
    aria-label="Loading comments"
  >
    <span>Loading comments...</span>
  </div>
</section>

<script
  is:inline
  define:vars={{
    giscusRepo,
    giscusRepoId,
    giscusCategory,
    giscusCategoryId,
    safeIdentifier,
    safeTitle,
    pageUrl,
    isConfigured,
    giscusTheme,
  }}
>
  (() => {
    const container = document.getElementById('giscus_thread')
    const loadingIndicator = document.getElementById('comments-loading')

    if (!container) return

    const showMessage = (message) => {
      if (loadingIndicator) {
        loadingIndicator.innerHTML = `<span class="text-muted-foreground">${message}</span>`
        loadingIndicator.setAttribute('role', 'alert')
      }
    }

    // If env vars missing, fallback defaults are used (for demo)

    const hideLoading = () => {
      if (loadingIndicator) loadingIndicator.style.display = 'none'
    }

    const renderGiscus = () => {
      container.innerHTML = ''

      const script = document.createElement('script')
      script.src = 'https://giscus.app/client.js'
      script.async = true
      script.crossOrigin = 'anonymous'

      script.setAttribute('data-repo', giscusRepo)
      script.setAttribute('data-repo-id', giscusRepoId)
      script.setAttribute('data-category', giscusCategory)
      script.setAttribute('data-category-id', giscusCategoryId)
      script.setAttribute('data-mapping', 'pathname')
      script.setAttribute('data-term', safeIdentifier || pageUrl)
      script.setAttribute('data-reactions-enabled', '1')
      script.setAttribute('data-emit-metadata', '0')
      script.setAttribute('data-input-position', 'bottom')
      script.setAttribute('data-theme', giscusTheme || 'preferred_color_scheme')
      script.setAttribute('data-lang', 'en')
      script.setAttribute('data-loading', 'lazy')
      script.setAttribute('data-strict', '0')

      script.onload = hideLoading
      script.onerror = () => showMessage('Unable to load comments.')

      container.appendChild(script)
    }

    const loadGiscus = () => {
      renderGiscus()
    }

    const initObserver = () => {
      if (!('IntersectionObserver' in window)) {
        loadGiscus()
        return
      }

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              loadGiscus()
              observer.disconnect()
            }
          })
        },
        { rootMargin: '200px', threshold: 0.1 },
      )

      observer.observe(container)
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initObserver)
    } else {
      initObserver()
    }

    document.addEventListener('astro:page-load', () => {
      if (loadingIndicator) {
        loadingIndicator.style.display = 'flex'
        loadingIndicator.innerHTML = '<span>Loading comments...</span>'
      }
      renderGiscus()
    })
  })()
</script>

<noscript>
  <div class="mt-12 rounded-lg border bg-muted/50 p-6 text-center text-sm text-muted-foreground">
    <p>
      Please enable JavaScript to view the comments powered by Giscus.
    </p>
  </div>
</noscript>
