---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import Link from '@/components/Link.astro'
import { Icon } from 'astro-icon/components'
import { getAllWikiPosts, getWikiTree } from '@/lib/data-utils'

const pageUrl = new URL(Astro.url.pathname, Astro.site).href

const posts = await getAllWikiPosts()
const wikiTree = await getWikiTree()

const topLevelFolders = wikiTree
  .filter((node) => node.isFolder || node.children.length > 0)
  .map((node) => {
    const indexPost =
      posts.find((p) => p.id === `${node.id}/index`) ||
      posts.find((p) => p.id === node.id)

    return {
      id: node.id,
      title: indexPost?.data.title || node.title,
      description:
        indexPost?.data.description ||
        'Browse the resources inside this folder.',
      href: `/wiki/${indexPost ? indexPost.id : node.id}`,
      count: node.children.length,
    }
  })

const categories = Array.from(
  new Set(
    [
      ...topLevelFolders.map((folder) => folder.title).filter(Boolean),
      'Networking',
      'Automation',
      'DevOps',
      'Security',
      'Linux',
      'Windows',
      'Cloud',
    ],
  ),
)

const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Wiki",
  "description": "Collection of learning resources, guides, and interactive tools for developers and system administrators.",
  "url": pageUrl,
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": topLevelFolders.map((folder, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "name": folder.title,
      "url": new URL(folder.href, Astro.site).href
    }))
  }
}

const getFolderImage = (id: string) => `/og/wiki/${id}.png`
const MAX_VISIBLE_CATEGORIES = 6
const visibleRootCategories = categories.slice(0, MAX_VISIBLE_CATEGORIES)
const hiddenRootCount = categories.length - visibleRootCategories.length
const hiddenRootCategories = categories.slice(MAX_VISIBLE_CATEGORIES)
---

<Layout class="max-w-3xl">
  <PageHead 
    slot="head" 
    title="Wiki - Interactive Tools & Guides"
    description="Free online learning resources and tools for system administrators, developers, and IT professionals."
  />
  
  <script is:inline type="application/ld+json" set:html={JSON.stringify(structuredData)} />

  <Breadcrumbs items={[{ label: 'Wiki', icon: 'lucide:book-open' }]} />

  <article class="flex flex-col gap-y-6">
    <div class="space-y-2">
      {categories.length > 0 && (
        <div class="flex flex-col gap-2">
          <h2 class="text-lg font-semibold tracking-wide text-muted-foreground">Categories</h2>
          <div class="relative flex flex-wrap items-center gap-2 pt-1 text-[12px]">
            <button
              class="rounded-full border border-border bg-muted/60 px-3 py-1 font-semibold text-foreground/80 transition-colors hover:bg-muted"
              data-filter="all"
            >
              All
            </button>
            {categories.map((cat, index) => (
              <button
                class={`rounded-full border border-border bg-muted/60 px-3 py-1 font-semibold text-foreground/80 transition-colors hover:bg-muted ${index >= MAX_VISIBLE_CATEGORIES ? 'hidden' : ''}`}
                data-filter={cat}
                data-hidden={index >= MAX_VISIBLE_CATEGORIES ? 'true' : 'false'}
              >
                {cat}
              </button>
            ))}
            {hiddenRootCount > 0 && (
              <button
                class="rounded-full border border-border bg-muted/60 px-3 py-1 font-semibold text-foreground/80 transition-colors hover:bg-muted"
                data-more-button="true"
                aria-expanded="false"
              >
                + {hiddenRootCount} more
              </button>
            )}
          </div>
        </div>
      )}
    </div>

    <div class="grid gap-4 sm:grid-cols-2">
      {topLevelFolders.map((folder) => (
        <Link
          href={folder.href}
          data-category={folder.title}
          class="group relative block w-full overflow-hidden rounded-2xl border border-border/60 bg-muted/40 shadow-sm transition-all duration-300 hover:-translate-y-1 hover:shadow-md"
        >
          <div class="aspect-[16/9] w-full overflow-hidden border-b border-border/50 bg-muted/40">
            <div
              class="h-full w-full bg-cover bg-center transition-transform duration-500 group-hover:scale-[1.03]"
              style={`background-image: url('${getFolderImage(folder.id)}');`}
              aria-hidden="true"
            />
          </div>

          <div class="flex items-start justify-between gap-3 p-5">
            <div class="space-y-2">
              <h2 class="text-lg font-bold leading-tight text-foreground transition-colors duration-300 group-hover:text-primary">
                {folder.title}
              </h2>
              <p class="text-sm text-muted-foreground/80 line-clamp-2">
                {folder.description}
              </p>
            </div>
            <Icon
              name="lucide:arrow-up-right"
              class="mt-1 size-4 shrink-0 text-muted-foreground transition-all duration-300 group-hover:-translate-y-0.5 group-hover:translate-x-0.5 group-hover:text-primary"
            />
          </div>
        </Link>
      ))}
    </div>
  </article>
</Layout>

  <script is:inline>
  (() => {
    const cards = Array.from(document.querySelectorAll('[data-category]'))
    const buttons = Array.from(document.querySelectorAll('button[data-filter]'))
    const moreButton = document.querySelector('[data-more-button="true"]')
    const hiddenPills = Array.from(
      document.querySelectorAll('button[data-hidden="true"]'),
    )
    let expanded = false

    const setActive = (value) => {
      buttons.forEach((btn) => {
        const isActive = btn.dataset.filter === value
        btn.classList.toggle('bg-primary/10', isActive)
        btn.classList.toggle('text-primary', isActive)
      })
    }

    const applyFilter = (value) => {
      cards.forEach((card) => {
        const cat = card.getAttribute('data-category')
        const show = value === 'all' || cat === value
        card.classList.toggle('hidden', !show)
      })
      setActive(value)
    }

    const toggleHidden = () => {
      expanded = !expanded
      hiddenPills.forEach((pill) => {
        pill.classList.toggle('hidden', !expanded)
      })
      if (moreButton) {
        moreButton.textContent = expanded
          ? 'Show less'
          : `+ ${hiddenPills.length} more`
        moreButton.setAttribute('aria-expanded', expanded ? 'true' : 'false')
      }
    }

    buttons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const filter = btn.dataset.filter || 'all'
        applyFilter(filter)
      })
    })

    if (moreButton) {
      moreButton.addEventListener('click', (e) => {
        e.preventDefault()
        toggleHidden()
      })
    }

    // Default active state is "all"
    setActive('all')
  })()
</script>
