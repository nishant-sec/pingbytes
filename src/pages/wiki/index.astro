---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import Link from '@/components/Link.astro'
import { Icon } from 'astro-icon/components'
import { ScrollArea } from '@/components/ui/scroll-area'
import { getAllWikiPosts, getWikiTree } from '@/lib/data-utils'

const pageUrl = new URL(Astro.url.pathname, Astro.site).href

const posts = await getAllWikiPosts()
const wikiTree = await getWikiTree()

const topLevelFolders = wikiTree
  .filter((node) => node.isFolder || node.children.length > 0)
  .map((node) => {
    const indexPost =
      posts.find((p) => p.id === `${node.id}/index`) ||
      posts.find((p) => p.id === node.id)

    return {
      id: node.id,
      title: indexPost?.data.title || node.title,
      description:
        indexPost?.data.description ||
        'Browse the resources inside this folder.',
      href: `/wiki/${indexPost ? indexPost.id : node.id}`,
      count: node.children.length,
    }
  })

const categories = Array.from(
  new Set(
    [
      ...topLevelFolders.map((folder) => folder.title).filter(Boolean),
      'Networking',
      'Automation',
      'DevOps',
      'Security',
      'Linux',
      'Windows',
      'Cloud',
      'Kubernetes',
      'Containers',
      'Monitoring',
      'Observability',
      'SRE',
      'CI/CD',
      'Databases',
      'Identity',
      'Compliance',
      'Performance',
      'Storage',
    ],
  ),
)

const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Wiki",
  "description": "Collection of learning resources, guides, and interactive tools for developers and system administrators.",
  "url": pageUrl,
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": topLevelFolders.map((folder, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "name": folder.title,
      "url": new URL(folder.href, Astro.site).href
    }))
  }
}

const getFolderImage = (id: string) => `/og/wiki/${id}.png`
const MAX_VISIBLE_CATEGORIES = 6
const visibleRootCategories = categories.slice(0, MAX_VISIBLE_CATEGORIES)
const hiddenRootCount = categories.length - visibleRootCategories.length
const hiddenRootCategories = categories.slice(MAX_VISIBLE_CATEGORIES)
---

<Layout class="max-w-3xl">
  {categories.length > 0 && (
    <div slot="table-of-contents" class="w-full xl:hidden border-b border-border/60">
      <details class="group">
        <summary class="flex w-full cursor-pointer items-center justify-between">
          <div class="mx-auto flex w-full max-w-3xl items-center px-4 py-3">
            <span class="text-muted-foreground flex-grow truncate text-sm">
              <span id="mobile-categories-current">Categories</span>
            </span>
            <span class="text-muted-foreground ml-2">
              <Icon
                name="lucide:chevron-down"
                class="h-4 w-4 transition-transform duration-200 group-open:rotate-180"
              />
            </span>
          </div>
        </summary>
        <ScrollArea client:visible className="mx-auto max-w-3xl" data-categories-scroll>
          <div class="max-h-[30vh] px-4 pb-4">
            <div class="js-category-pills relative flex flex-wrap items-center gap-2 pt-1 text-[12px]">
              <button
                class="rounded-full border border-border bg-muted/60 px-3 py-1 font-semibold text-foreground/80 transition-colors hover:bg-muted"
                data-filter="all"
              >
                All
              </button>
              {categories.map((cat, index) => (
                <button
                  class={`rounded-full border border-border bg-muted/60 px-3 py-1 font-semibold text-foreground/80 transition-colors hover:bg-muted ${index >= MAX_VISIBLE_CATEGORIES ? 'hidden' : ''}`}
                  data-filter={cat}
                  data-hidden={index >= MAX_VISIBLE_CATEGORIES ? 'true' : 'false'}
                >
                  {cat}
                </button>
              ))}
              {hiddenRootCount > 0 && (
                <button
                  class="rounded-full border border-border bg-muted/60 px-3 py-1 font-semibold text-foreground/80 transition-colors hover:bg-muted"
                  data-more-button="true"
                  aria-expanded="false"
                >
                  + {hiddenRootCount} more
                </button>
              )}
            </div>
          </div>
        </ScrollArea>
      </details>
    </div>
  )}

  <PageHead 
    slot="head" 
    title="Wiki - Interactive Tools & Guides"
    description="Free online learning resources and tools for system administrators, developers, and IT professionals."
  />
  
  <script is:inline type="application/ld+json" set:html={JSON.stringify(structuredData)} />

  <Breadcrumbs items={[{ label: 'Wiki', icon: 'lucide:book-open' }]} />

  <article class="flex flex-col gap-y-6">
    {categories.length > 0 && (
      <div class="hidden xl:block space-y-2">
        <div class="flex flex-col gap-2">
          <h2 class="text-lg font-semibold tracking-wide text-muted-foreground">Categories</h2>
          <div class="js-category-pills relative flex flex-wrap items-center gap-2 pt-1 text-[12px]">
            <button
              class="rounded-full border border-border bg-muted/60 px-3 py-1 font-semibold text-foreground/80 transition-colors hover:bg-muted"
              data-filter="all"
            >
              All
            </button>
            {categories.map((cat, index) => (
              <button
                class={`rounded-full border border-border bg-muted/60 px-3 py-1 font-semibold text-foreground/80 transition-colors hover:bg-muted ${index >= MAX_VISIBLE_CATEGORIES ? 'hidden' : ''}`}
                data-filter={cat}
                data-hidden={index >= MAX_VISIBLE_CATEGORIES ? 'true' : 'false'}
              >
                {cat}
              </button>
            ))}
            {hiddenRootCount > 0 && (
              <button
                class="rounded-full border border-border bg-muted/60 px-3 py-1 font-semibold text-foreground/80 transition-colors hover:bg-muted"
                data-more-button="true"
                aria-expanded="false"
              >
                + {hiddenRootCount} more
              </button>
            )}
          </div>
        </div>
      </div>
    )}

    <div class="grid gap-4 sm:grid-cols-2">
      {topLevelFolders.map((folder) => (
        <Link
          href={folder.href}
          data-category={folder.title}
          class="group relative block w-full overflow-hidden rounded-2xl border border-border/60 bg-muted/40 shadow-sm transition-all duration-300 hover:-translate-y-1 hover:shadow-md"
        >
          <div class="aspect-[16/9] w-full overflow-hidden border-b border-border/50 bg-muted/40">
            <div
              class="h-full w-full bg-cover bg-center transition-transform duration-500 group-hover:scale-[1.03]"
              style={`background-image: url('${getFolderImage(folder.id)}');`}
              aria-hidden="true"
            />
          </div>

          <div class="flex items-start justify-between gap-3 p-5">
            <div class="space-y-2">
              <h2 class="text-lg font-bold leading-tight text-foreground transition-colors duration-300 group-hover:text-primary">
                {folder.title}
              </h2>
              <p class="text-sm text-muted-foreground/80 line-clamp-2">
                {folder.description}
              </p>
            </div>
            <Icon
              name="lucide:arrow-up-right"
              class="mt-1 size-4 shrink-0 text-muted-foreground transition-all duration-300 group-hover:-translate-y-0.5 group-hover:translate-x-0.5 group-hover:text-primary"
            />
          </div>
        </Link>
      ))}
    </div>
  </article>
</Layout>

  <script is:inline>
  (() => {
    const cards = Array.from(document.querySelectorAll('[data-category]'))
    const groups = Array.from(document.querySelectorAll('.js-category-pills'))
    const mobileLabel = document.getElementById('mobile-categories-current')
    let activeFilter = 'all'

    const setMobileLabel = (value) => {
      if (!mobileLabel) return
      mobileLabel.textContent =
        value && value !== 'all' ? value : 'Categories'
    }

    const filterCards = (value) => {
      cards.forEach((card) => {
        const cat = card.getAttribute('data-category')
        const show = value === 'all' || cat === value
        card.classList.toggle('hidden', !show)
      })
    }

    const setupGroup = (container) => {
      const buttons = Array.from(
        container.querySelectorAll('button[data-filter]'),
      )
      const moreButton = container.querySelector('[data-more-button="true"]')
      const hiddenPills = buttons.filter(
        (pill) => pill.dataset.hidden === 'true',
      )
      const allButton = buttons.find((btn) => btn.dataset.filter === 'all')
      let expanded = false

      buttons.forEach((btn, index) => {
        btn.dataset.index = `${index}`
        btn.dataset.label = btn.textContent.trim()
      })

      const updateLabels = (activeBtn) => {
        buttons.forEach((btn) => {
          const label = btn.dataset.label || btn.textContent.trim()
          const isActive = btn === activeBtn && btn.dataset.filter !== 'all'
          btn.innerHTML = isActive
            ? `${label} <span aria-hidden="true" class="ml-1">&times;</span>`
            : label
          btn.setAttribute('aria-pressed', btn === activeBtn ? 'true' : 'false')
          btn.setAttribute(
            'aria-label',
            isActive ? `${label} selected. Click to clear filter.` : label,
          )
        })
      }

      const setActiveStyles = (value) => {
        buttons.forEach((btn) => {
          const isActive = btn.dataset.filter === value
          btn.classList.toggle('bg-primary/10', isActive)
          btn.classList.toggle('text-primary', isActive)
        })
      }

      const reorderPills = (activeBtn) => {
        const sorted = [...buttons].sort((a, b) => {
          if (a === activeBtn) return -1
          if (b === activeBtn) return 1
          const ai = Number(a.dataset.index || 0)
          const bi = Number(b.dataset.index || 0)
          return ai - bi
        })
        sorted.forEach((btn) => container.appendChild(btn))
        if (moreButton) container.appendChild(moreButton)
      }

      const syncHiddenVisibility = (activeBtn) => {
        hiddenPills.forEach((pill) => {
          const keepVisible = pill === activeBtn
          pill.classList.toggle('hidden', !expanded && !keepVisible)
        })
        if (moreButton) {
          moreButton.textContent = expanded
            ? 'Show less'
            : `+ ${hiddenPills.length} more`
          moreButton.setAttribute('aria-expanded', expanded ? 'true' : 'false')
        }
      }

      const update = (value) => {
        const activeBtn =
          buttons.find((btn) => btn.dataset.filter === value) || allButton
        expanded = false
        setActiveStyles(value)
        updateLabels(activeBtn)
        reorderPills(activeBtn)
        syncHiddenVisibility(activeBtn)
        return activeBtn
      }

      const toggleHidden = (value) => {
        expanded = !expanded
        const activeBtn =
          buttons.find((btn) => btn.dataset.filter === value) || allButton
        syncHiddenVisibility(activeBtn)
      }

      return {
        buttons,
        moreButton,
        update,
        toggleHidden,
        allButton,
        container,
      }
    }

    const groupStates = groups.map((group) => setupGroup(group))

    const applyFilter = (value) => {
      activeFilter = value
      filterCards(value)
      let labelValue = 'Categories'
      groupStates.forEach((group) => {
        const activeBtn = group.update(value)
        const details = group.container?.closest('details')
        if (details) details.removeAttribute('open')
        if (
          activeBtn &&
          activeBtn.dataset.filter &&
          activeBtn.dataset.filter !== 'all'
        ) {
          labelValue = activeBtn.dataset.label || activeBtn.dataset.filter
        }
      })
      setMobileLabel(labelValue)
    }

    groupStates.forEach((group) => {
      group.buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const filter = btn.dataset.filter || 'all'
          const newFilter =
            activeFilter === filter && filter !== 'all' ? 'all' : filter
          applyFilter(newFilter)
        })
      })
      if (group.moreButton) {
        group.moreButton.addEventListener('click', (e) => {
          e.preventDefault()
          group.toggleHidden(activeFilter)
        })
      }
    })

    // Default active state is "all"
    applyFilter('all')
  })()
</script>
