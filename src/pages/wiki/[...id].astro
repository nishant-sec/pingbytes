---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PostHead from '@/components/PostHead.astro'
import TOCHeader from '@/components/TOCHeader.astro'
import TOCSidebar from '@/components/TOCSidebar.astro'
import WikiSidebar from '@/components/WikiSidebar.astro' 
import { badgeVariants } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { ScrollArea } from '@/components/ui/scroll-area'
import Layout from '@/layouts/Layout.astro'
import { getAllWikiPosts, parseAuthors, getWikiTree } from '@/lib/data-utils'
import { formatDate, getTagVariant, readingTime, calculateWordCountFromHtml } from '@/lib/utils'
import { Icon } from 'astro-icon/components'
import { Image } from 'astro:assets'
import { render } from 'astro:content'
import type { CollectionEntry } from 'astro:content'

// 1. Fetch all Wiki posts to generate routes
export async function getStaticPaths() {
  const posts = await getAllWikiPosts()
  return posts.map((post) => ({
    params: { id: post.id },
    props: post,
  }))
}

const post = Astro.props
const currentPostId = Astro.params.id

// 2. Render content and headings
const { Content, headings } = await render(post)

// 3. Handle Authors
const authors = await parseAuthors(post.data.authors ?? [])

// 4. Calculate Reading Time
const wordCount = calculateWordCountFromHtml(post.body || '')
const postReadingTime = readingTime(wordCount)

// 5. Get Wiki Tree for Sidebar
const wikiTree = await getWikiTree()

// 6. Generate Simple TOC
const tocSections = [
  {
    type: 'parent' as const,
    title: 'Overview',
    headings: headings.map((h) => ({
      slug: h.slug,
      text: h.text,
      depth: h.depth,
    })),
  },
]
---

<Layout>
  <PostHead slot="head" post={post as unknown as CollectionEntry<'blog'>} />
  
  {/* Table of Contents Header (Visible on Mobile) */}
  {headings?.length > 0 && <TOCHeader slot="table-of-contents" headings={headings} />}

  <div class="grid w-full gap-10 lg:grid-cols-[240px_minmax(0,1fr)] xl:grid-cols-[240px_minmax(0,1fr)_240px]">
    
    {/* Left Sidebar: Wiki Navigation */}
    <aside class="fixed top-24 z-30 -ml-2 hidden h-[calc(100vh-6rem)] w-full shrink-0 overflow-y-auto border-r md:sticky lg:block">
        <ScrollArea client:load className="h-full pr-4">
            <WikiSidebar tree={wikiTree} currentPostId={post.id} />
        </ScrollArea>
    </aside>

    {/* Main Content Area */}
    <section class="flex flex-col gap-y-6 min-w-0">
      
      {/* Breadcrumbs */}
      <div>
        <Breadcrumbs
          items={[
            { href: '/wiki', label: 'Wiki', icon: 'lucide:book-open' },
            { label: post.data.title, icon: 'lucide:file-text' },
          ]}
        />
      </div>

      {/* Featured Image */}
      {post.data.image && (
        <Image
          src={post.data.image}
          alt={post.data.title}
          width={1200}
          height={630}
          class="mx-auto w-full max-w-5xl rounded-lg object-cover shadow-sm"
        />
      )}

      {/* Post Header */}
      <div class="flex flex-col gap-y-4 border-b pb-6">
          <h1 class="text-3xl font-bold tracking-tight sm:text-4xl">
            {post.data.title}
          </h1>

          <div class="text-muted-foreground flex flex-wrap items-center gap-x-4 gap-y-2 text-sm">
            {authors.length > 0 && (
              <div class="flex items-center gap-x-2">
                {authors.map((author) => (
                  <div class="flex items-center gap-x-1.5">
                    <Image src={author.avatar} alt={author.name} width={20} height={20} class="rounded-full" />
                    <span>{author.name}</span>
                  </div>
                ))}
              </div>
            )}

            <span>{formatDate(post.data.date)}</span>
            <span>{postReadingTime}</span>
          </div>

          {post.data.tags && post.data.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 pt-2">
              {post.data.tags.map((tag) => {
                const { variant, className } = getTagVariant(tag)
                return (
                  <a href={`/tags/${tag}`} class={badgeVariants({ variant, className })}>
                    <Icon name="lucide:hash" class="mr-1 size-3" />
                    {tag}
                  </a>
                )
              })}
            </div>
          )}
      </div>

      {/* Markdown Content */}
      <article class="prose dark:prose-invert max-w-none">
        <Content />
      </article>

    </section>

    {/* Right Sidebar: TOC */}
    {tocSections.length > 0 && (
      <div class="hidden xl:block">
        <div class="sticky top-24 h-[calc(100vh-6rem)] overflow-y-auto">
             <TOCSidebar sections={tocSections} currentPostId={currentPostId} />
        </div>
      </div>
    )}

  </div>

  <Button
    variant="outline"
    size="icon"
    className="group fixed right-8 bottom-8 z-50 hidden"
    id="scroll-to-top"
    title="Scroll to top"
  >
    <Icon name="lucide:arrow-up" class="mx-auto size-4 transition-all group-hover:-translate-y-0.5" />
  </Button>

  <script>
    document.addEventListener('astro:page-load', () => {
      const btn = document.getElementById('scroll-to-top')
      if (btn) {
        btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }))
        window.addEventListener('scroll', () => {
          btn.classList.toggle('hidden', window.scrollY <= 300)
        })
      }
    })
  </script>
</Layout>